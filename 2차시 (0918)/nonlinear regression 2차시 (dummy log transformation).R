
caschool = read.csv("C:\\Users\\user\\Dropbox\\data\\caschool.csv",header=TRUE)                   #caschool file 
attach(caschool)

### Histogram
par(mfrow=c(1,2))
hist(avginc, breaks=50, probability=TRUE)
lines(density(avginc), col=2)                          

hist(log(avginc), breaks=50, probability=TRUE)
lines(density(log(avginc)), col=2)                     #log???????????????, ?????? ??? ??????????????? ?????????

hist(testscr, breaks=50, probability=TRUE)
lines(density(testscr), col=2)                          
#??????????????? ???????????? ????????? ????????? ?????? - ??????????????? ????????? ??????


#????????????
hist(log(testscr), breaks=50, probability=TRUE)
lines(density(log(testscr)), col=2)                     

lm.scr = lm(log(testscr)~avginc)
summary(lm.scr)
#????????? log (testscr) ??????????????? ????????? (p-value)

#y??? log ???????????????????????????
### Forecast ln(Y)
# income = 40, test score = ?
lm.scr$coef :b0??? b1
lnY = lm.scr$coef[1] + lm.scr$coef[2]*40
Y1 = exp(lnY)
Y1

#????????? ???????????? ?????????,
# lnY = b0 + b1X +u, u ~ N(0,variance of u)????????????,
# E[Y] = exp(b0+b1X)E(e^u) = exp(b0+b1X)*exp(variance of u/2)       
E(e^u)???????????? ???????????? ?????????

# (by mgf of normal distribution)
var.u = var(lm.scr$residual)
Y2 = exp(lnY)*exp(var.u/2) 
Y2

# Out of forecasting (E(u)?????????????????? ?????????????????? ????????? ???????????? ????????????)
400?????? ???????????? ?????????(testscr??? avginc) (yhat)
train.Y = testscr[1:400];               train.X = avginc[1:400]
#????????? ?????? ??????
test.Y = testscr[401:nrow(caschool)];   test.X = avginc[401:nrow(caschool)]


#
lm.scr = lm(log(train.Y)~train.X)                                 # Model fitting to train data
fore.lnY = lm.scr$coef[1] + lm.scr$coef[2]*test.X                      # Forecast lnY (b0hat??? b1hat)

# Forecast method1 
fore.Y1 = exp(fore.lnY)                      
head(fore.Y1)

# Forecast method2 (u??? variance??????)
u = lm.scr$residual
fore.Y2 = exp(fore.lnY)*exp(var(u)/2)       
head(fore.Y2)

# Forecast comparison (????????? ??????:???????????? ????????? ?????? MSE)
# Measure : RMSE = mean of squared forecasting error 
MSE1 = mean((test.Y-fore.Y1)^2)
MSE2 = mean((test.Y-fore.Y2)^2) #20?????? ?????????(15')

MSE1
MSE2
#originally, variance of u??????????????? ??? ????????? ?????????
hist(u,breaks=50) #??????????????? ???????????? ?????? ????????? ??????????????? ?????????
#5' ?????? ????????? ???????????? ????????????????????? ?????????????????? ??? ??? ??????


### Dummy variable in linear regression (???????????? ??????)
HiEL = ifelse(el_pct>10, 1, 0) #?????????????????????>10%
lm.fit = lm(testscr~str+HiEL+str*HiEL) #??????????????????
summary(lm.fit)
#p-value?????? ?????? ?????? X 
#Fstatistic ??????, b1 b2 b3 ??? ????????? ????????? 0??? ?????????????????? p-value <0.05??? ??????????????? ??????
#??? ????????? ??????????????? ??????????????? ???????????????

#???????????????????????? ?????? ?????? ??????? EXAMPLE
### Multicollinearity
X1 = avginc   
X2 = 0.95*X1 + 0.05*str #X1??? X2??? cor ?????? ??????

#X1??? X2 ?????? ????????? ??????
par(mfrow=c(1,2))
plot(avginc, str, pch=19)
plot(X1, X2, pch=19)  #??? ?????? ??????????????? ????????? ?????? ????????? ??? ??????

#regression
lm.fit3 = lm(testscr~avginc+str)
summary(lm.fit3)

lm.fit2 = lm(testscr~X1+X2)
summary(lm.fit2)

#??????????????? ???????????? (wild?????? ??????)
#X1??? ???????????? X2??? ?????? ??????( ??????????????? ?????? )
#????????? ????????? 0??? ????????? (F????????????)<-> X2??? ????????? ??????(????????????1%)
